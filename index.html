<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>智能网关</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .status {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .node {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .fastest {
            background: #e6ffe6;
        }
        .speed {
            color: #666;
        }
    </style>
</head>
<body>
    <div id="status" class="status">正在测速...</div>
    <div id="results"></div>

    <script>
        const nodes = [
            { name: "Cloudflare Pages", url: "https://blog.acofork.us.kg" },
            { name: "Fleek", url: "https://fleek-blog.acofork.us.kg" },
            { name: "Vercel", url: "https://vercel-blog.acofork.us.kg" },
            { name: "Github Pages", url: "https://github-blog.acofork.us.kg" }
        ];

        const currentPath = window.location.pathname + window.location.search + window.location.hash;
        const resultsDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');

        // 更新节点状态显示
        function updateNodeStatus(node, speed) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'node';
            nodeDiv.innerHTML = `
                <span>${node.name}</span>
                <span class="speed">${speed === 99999 ? '超时' : speed + 'ms'}</span>
            `;
            resultsDiv.appendChild(nodeDiv);
            return nodeDiv;
        }

        // 测试单个节点
        async function testNode(node) {
            const startTime = performance.now();
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒超时

                const response = await fetch(node.url, {
                    mode: 'no-cors',
                    cache: 'no-store',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const speed = Math.round(performance.now() - startTime);
                return { node, speed, nodeDiv: updateNodeStatus(node, speed) };
            } catch {
                return { node, speed: 99999, nodeDiv: updateNodeStatus(node, 99999) };
            }
        }

        // 测试所有节点
        async function findFastestNode() {
            let completedTests = 0;
            let fastestNode = null;
            let fastestSpeed = Infinity;

            try {
                // 并行测试所有节点
                const tests = nodes.map(async node => {
                    const result = await testNode(node);
                    completedTests++;

                    // 更新最快节点
                    if (result.speed < fastestSpeed && result.speed !== 99999) {
                        if (fastestNode) {
                            fastestNode.nodeDiv.classList.remove('fastest');
                        }
                        fastestNode = result;
                        fastestSpeed = result.speed;
                        result.nodeDiv.classList.add('fastest');
                    }

                    // 如果这是最快的可用节点，立即重定向
                    if (completedTests === nodes.length && fastestNode) {
                        statusDiv.textContent = `已找到最快节点: ${fastestNode.node.name} (${fastestNode.speed}ms)，正在跳转...`;
                        window.location.href = fastestNode.node.url + currentPath;
                    }
                });

                await Promise.all(tests);
                
                // 如果所有节点都测试完但都失败了
                if (!fastestNode) {
                    statusDiv.textContent = '所有节点均无法访问，请刷新重试';
                }
            } catch (error) {
                statusDiv.textContent = '测速过程出错，请刷新重试';
            }
        }

        // 开始测速
        findFastestNode();
    </script>
</body>
</html>